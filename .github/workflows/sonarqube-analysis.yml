name: SonarQube Analysis

on:
  push:
    branches:
      - sonar-analysis
  pull_request:
    branches:
      - sonar-analysis

jobs:
  analyze-code:
    name: Run SonarQube Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      - name: Cache SonarQube Packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar

      - name: Cache Maven Packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build project
        run: mvn clean install -DskipTests=false

      - name: Run Unit Tests
        run: mvn test

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.organization=your-org-name
            -Dsonar.projectKey=your-project-key
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

---
## **3ï¸âƒ£ HÆ°á»›ng dáº«n táº¡o SONAR_TOKEN**
Báº¡n cÃ³ thá»ƒ láº¥y `SONAR_TOKEN` tá»« SonarQube hoáº·c **SonarCloud** theo cÃ¡c bÆ°á»›c sau:  

### **A. Láº¥y `SONAR_TOKEN` tá»« SonarQube (Self-hosted)**
1. Truy cáº­p **SonarQube Server** cá»§a báº¡n (vÃ­ dá»¥: `http://your-sonarqube-server.com`)
2. ÄÄƒng nháº­p vÃ o tÃ i khoáº£n cá»§a báº¡n.
3. Chá»n **My Account** (GÃ³c trÃªn cÃ¹ng bÃªn pháº£i)
4. Chuyá»ƒn Ä‘áº¿n tab **Security**  
5. Trong pháº§n **Tokens**, nháº­p mÃ´ táº£ vÃ  nháº¥n **Generate**.
6. Sao chÃ©p token vÃ  **lÆ°u láº¡i ngay**, vÃ¬ báº¡n chá»‰ cÃ³ thá»ƒ xem má»™t láº§n!

---

### **B. LÆ°u `SONAR_TOKEN` vÃ o GitHub Secrets**
Äá»ƒ lÆ°u giÃ¡ trá»‹ `SONAR_TOKEN` má»™t cÃ¡ch an toÃ n:  
1. Truy cáº­p **GitHub repository** cá»§a báº¡n.  
2. VÃ o pháº§n **Settings** â†’ Chá»n **Secrets and variables** â†’ Click vÃ o **Actions**.  
3. Nháº¥n vÃ o nÃºt **New repository secret**.  
4. Nháº­p tÃªn secret lÃ : `SONAR_TOKEN`.  
5. DÃ¡n giÃ¡ trá»‹ token mÃ  báº¡n vá»«a copy vÃ o pháº§n **Secret**.  
6. Nháº¥n **Add secret** Ä‘á»ƒ lÆ°u láº¡i.  

ğŸ”¥ **LÆ°u Ã½:**  
Sau khi thÃªm vÃ o **Secrets**, báº¡n **khÃ´ng thá»ƒ xem láº¡i** giÃ¡ trá»‹ `SONAR_TOKEN`, nÃªn náº¿u lá»¡ quÃªn lÆ°u, báº¡n pháº£i xÃ³a Ä‘i vÃ  táº¡o láº¡i.  

---

## **3ï¸âƒ£ Cháº¡y CI/CD trÃªn GitHub Actions**
Sau khi Ä‘Ã£ cÃ³ `SONAR_TOKEN` vÃ  sá»­a file workflow, báº¡n cÃ³ thá»ƒ **push nhÃ¡nh `sonar-analysis` lÃªn GitHub**, há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng kÃ­ch hoáº¡t GitHub Actions.

### **Push nhÃ¡nh lÃªn GitHub**
```sh
git add .  
git commit -m "ThÃªm CI/CD chá»‰ cháº¡y SonarQube"  
git push origin sonar-analysis
